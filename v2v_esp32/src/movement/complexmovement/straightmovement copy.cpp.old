#include <Arduino.h>
#include "straightmovement.h"
#include "sensors/sensors.h"
#include "vehicle/vehicle.h"

namespace Movement
{
    StraightMovement::StraightMovement() : BasicMovement()
    {
        this->state = StartCrossing;
        this->isDone = false;
        // this->isPaused = false;
        this->backupStartTime = 0;
    }
    void StraightMovement::run()
    {
        Vehicle::ROVER.setMaxMovementSpeed(MAX_STRAIGHT_MOVEMENT_SPEED);

        if (this->isDone)
        {
            Vehicle::ROVER.set(0, 90);
            return;
        }

        bool left = Sensors::LINE_SENSOR.right();
        bool center = Sensors::LINE_SENSOR.center();
        bool right = Sensors::LINE_SENSOR.left();

        switch (this->state)
        {
        case StartCrossing:
            if (left && right && center)
            {
                Vehicle::ROVER.set(255, 90);
            }

            if (left && !center && !right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }
            if (left && center && !right)
            {
                Vehicle::ROVER.set(255, 90 + TURN_DELTA);
            }

            if (!left && !center && right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }
            if (!left && center && right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }

            if (!left && !right && !left)
            {
                Vehicle::ROVER.set(0, 90);
            }

            if (!left && center && !right)
            {
                this->state = Continuing;
                Vehicle::ROVER.set(255, 90);
            }
            break;
        case Continuing:
            if (left && !center && !right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }
            if (left && center && !right)
            {
                Vehicle::ROVER.set(255, 90 + TURN_DELTA);
            }

            if (!left && !center && right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }
            if (!left && center && right)
            {
                Vehicle::ROVER.set(255, 90 - TURN_DELTA);
            }
            if (!left && center && !right)
            {
                Vehicle::ROVER.set(255, 90);
            }
            if (!left && !right && !center)
            {
                Vehicle::ROVER.set(0, 90);
            }
            if (left && center && right)
            {
                this->state = EndCrossing;
                this->backupStartTime = millis();
                Vehicle::ROVER.set(255, 270);
            }
            break;
        case EndCrossing:
            if (this->backupStartTime + 100 > millis())
            {
                this->isDone = true;
                Vehicle::ROVER.set(0, 90);
            }

            break;
        default:
            break;
        }
    }
} // namespace Movement
